{% extends 'public/base.html' %}

{% block header %}
<!-- Data Tables -->
<link href="__static__/hplus/css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
<link href="__static__/hplus/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
{% endblock %}

{% block body %}
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="ibox ">
            <div class="ibox-title">
                <button onclick="addFunction();" class="btn btn-primary btn-outline">添加系统功能</button>
            </div>
            <div class="ibox-content">
                <table class="table table-striped table-bordered table-hover " id="functionTable">
                    <thead>
                    <tr>
                        <th>模块</th>
                        <th>控制器</th>
                        <th>方法</th>
                        <th>名称</th>
                        <th>描述</th>
                        <th>类型</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>
{% endblock %}

{% block scripts %}
<script src="__static__/hplus/js/jquery.min.js?v=2.1.4"></script>
<script src="__static__/hplus/js/plugins/bootbox/bootbox.min.js"></script>
<script src="__static__/hplus/js/bootstrap.min.js?v=3.3.5"></script>
<script src="__static__/hplus/js/plugins/jeditable/jquery.jeditable.js"></script>
<script src="__static__/hplus/js/plugins/dataTables/jquery.dataTables.js"></script>
<script src="__static__/hplus/js/plugins/dataTables/dataTables.bootstrap.js"></script>
<script src="__static__/hplus/js/content.min.js?v=1.0.0"></script>
<script>
    $(document).ready(function(){
        $("#functionTable").dataTable(
            {
                'iDisplayLength': 10,
                'bServerSide' : true,
                'aoColumns':[
                    {
                        "mData": 'module',
                        'sClass':'text-center',
                        'sWidth':'20',
                        'bSortable':false
                    }, {
                        "mData": 'controller',
                        'sClass':'text-center',
                        'sWidth':'20',
                        'bSortable':false
                    }, {
                        "mData": 'action_name',
                        'sClass':'text-center',
                        'sWidth':'20',
                        'bSortable':false
                    }, {
                        "mData": 'name',
                        'sClass':'text-center',
                        'sWidth':'20',
                        'bSortable':false
                    }, {
                        "mData": 'description',
                        'sClass':'text-center',
                        'sWidth':'60',
                        'bSortable':false
                    }, {
                        "mData": 'type',
                        'sClass':'text-center',
                        'sWidth':'20',
                        'bSortable':false
                    }, {
                        "mData": 'status',
                        'sClass':'text-center',
                        'sWidth':'20',
                        'bSortable':false
                    }, {
                        "mData": 'action',
                        'sClass':'text-center',
                        'sWidth':'80',
                        'bSortable':false
                    }
                ],
                'fnServerParams' : function (aoData) {
                    var elememts = getElements('#functionSearchForm');
                    $.each(elememts, function(key, val) {
                        aoData.push( { "name": key, "value": val } );
                    });
                },
                'aoColumnDefs' : [
                    {
                        'aTargets' : [7],
                        'mRender' : function (data, type, full) {
                            return '<button class="btn btn-info btn-outline" type="button" onclick="editFunction(' + full.id + ');"><i class="fa fa-paste"></i>编辑</button> &nbsp;&nbsp;'
                                +'<button class="btn btn-danger btn-outline" type="button" onclick="deleteFunction(' + full.id + ')"><i class="fa fa-trash"></i> <span class="bold">删除</span></button>';
                        }
                    }
                ],
                'sAjaxSource': '/admin/function/index',
                'fnServerData': function (sSource, aoData, fnCallback) {
                    $.ajax({
                        'type': 'post',
                        'url': sSource,
                        'dataType': 'json',
                        'data': {
                            aoData: JSON.stringify(aoData)
                        },
                        'success': function (resp) {
                            fnCallback(resp);
                        }
                    });
                },
                "fnRowCallback" : function(nRow, aData, iDisplayIndex) {
//                    if(aData.status == 0){
//                        $('td:eq(5)', nRow).html('<span class="label label-sm label-warning">禁用</span>');
//                    }else{
//                        $('td:eq(5)', nRow).html('<span class="label label-sm label-success">启用</span>');
//                    }
//                    return nRow;
                },
            }
        );
    });
    //获取表单参数
    function getElements(formId) {
        var elements = {};
        var data = $(formId).serializeArray();
        $.each(data, function() {
            elements[this.name] = this.value;
        });

        return elements;
    }
    //添加
    function addFunction() {
        $.ajax({
            url: 'addFunction',
            data: '',
            dataType: "html",
            type: 'GET',
            success: function (tpl) {
                var dialog = bootbox.dialog({
                    title: '添加系统功能',
                    message: tpl,
                });
            }
        });
    }
    //编辑
    function editFunction(id) {
        $.ajax({
            url: 'editFunction',
            data: {'fid' : id},
            dataType: 'html',
            type: 'GET',
            success: function (tpl) {
                var dialog = bootbox.dialog({
                    title: '编辑系统功能',
                    message: tpl,
                });
            }
        });
    }

    //删除
    function deleteFunction(id) {
        bootbox.confirm({
            message: "确定删除系统功能？",
            buttons: {
                confirm: {
                    label: '确认',
                    className: 'btn-success btn-outline'
                },
                cancel: {
                    label: '取消',
                    className: 'btn-danger btn-outline'
                }
            },
            callback: function (result) {
                if (result) {
                    $.ajax({
                        url: 'deleteFunction',
                        data: {'fid' : id},
                        dataType: "json",
                        type: 'POST',
                        success: function (json) {
                            if (json.code == 1) {
                                bootbox.hideAll();
                                bootbox.alert({
                                    message:json.msg,
                                    buttons: {
                                        ok: {
                                            label: '确定',
                                            className: 'btn-success'
                                        }
                                    },
                                    callback: function (data) {
                                        window.location.reload(true);
                                    }
                                });
                            } else {
                                bootbox.alert(json.msg);
                            }
                        }
                    });
                }
            }
        });
    }
</script>
{% endblock %}